[Unit]
Description=[WIP] Scouter Anaytics Database Restore
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Type=oneshot
KillMode=mixed
StateDirectory=scouter
SyslogIdentifier=%N
Delegate=yes
Type=notify
DynamicUser=yes
ProtectSystem=full
NoNewPrivileges=true
PrivateDevices=true
NotifyAccess=all
ExecStop=/usr/bin/podman rm -v -f -i --cidfile=%t/%N.cid
ExecStopPost=-/usr/bin/podman rm -v -f -i --cidfile=%t/%N.cid
ExecStart=/usr/bin/podman \
        run \
        --rm \
        --replace \
        --name %N \
        --cidfile=%t/%N.cid \
        --cgroups=split \
        --sdnotify=conmon \
        --env=STATE_DIRECTORY=${STATE_DIRECTORY} \
        --mount type=bind,src=/etc/scouter/litestream.yml,dst=/etc/litestream.yml,ro=true \
        --mount type=bind,src=${STATE_DIRECTORY},dst=${STATE_DIRECTORY} \
        docker://docker.io/litestream/litestream restore -if-replica-exists ${STATE_DIRECTORY}/scouter.db
